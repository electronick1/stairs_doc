
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Stairs documentation</title>

    <style>
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .gh {
  color: #999999;
}
.highlight .sr {
  color: #f6aa11;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .nb {
  color: #f6aa11;
}
.highlight .cm {
  color: #75715e;
}
.highlight .cp {
  color: #75715e;
}
.highlight .c1 {
  color: #75715e;
}
.highlight .cs {
  color: #75715e;
}
.highlight .c, .highlight .cd {
  color: #75715e;
}
.highlight .err {
  color: #960050;
}
.highlight .gr {
  color: #960050;
}
.highlight .gt {
  color: #960050;
}
.highlight .gd {
  color: #49483e;
}
.highlight .gi {
  color: #49483e;
}
.highlight .ge {
  color: #49483e;
}
.highlight .kc {
  color: #66d9ef;
}
.highlight .kd {
  color: #66d9ef;
}
.highlight .kr {
  color: #66d9ef;
}
.highlight .no {
  color: #66d9ef;
}
.highlight .kt {
  color: #66d9ef;
}
.highlight .mf {
  color: #ae81ff;
}
.highlight .mh {
  color: #ae81ff;
}
.highlight .il {
  color: #ae81ff;
}
.highlight .mi {
  color: #ae81ff;
}
.highlight .mo {
  color: #ae81ff;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #ae81ff;
}
.highlight .sc {
  color: #ae81ff;
}
.highlight .se {
  color: #ae81ff;
}
.highlight .ss {
  color: #ae81ff;
}
.highlight .sd {
  color: #e6db74;
}
.highlight .s2 {
  color: #e6db74;
}
.highlight .sb {
  color: #e6db74;
}
.highlight .sh {
  color: #e6db74;
}
.highlight .si {
  color: #e6db74;
}
.highlight .sx {
  color: #e6db74;
}
.highlight .s1 {
  color: #e6db74;
}
.highlight .s {
  color: #e6db74;
}
.highlight .na {
  color: #a6e22e;
}
.highlight .nc {
  color: #a6e22e;
}
.highlight .nd {
  color: #a6e22e;
}
.highlight .ne {
  color: #a6e22e;
}
.highlight .nf {
  color: #a6e22e;
}
.highlight .vc {
  color: #ffffff;
}
.highlight .nn {
  color: #ffffff;
}
.highlight .nl {
  color: #ffffff;
}
.highlight .ni {
  color: #ffffff;
}
.highlight .bp {
  color: #ffffff;
}
.highlight .vg {
  color: #ffffff;
}
.highlight .vi {
  color: #ffffff;
}
.highlight .nv {
  color: #ffffff;
}
.highlight .w {
  color: #ffffff;
}
.highlight {
  color: #ffffff;
}
.highlight .n, .highlight .py, .highlight .nx {
  color: #ffffff;
}
.highlight .ow {
  color: #f92672;
}
.highlight .nt {
  color: #f92672;
}
.highlight .k, .highlight .kv {
  color: #f92672;
}
.highlight .kn {
  color: #f92672;
}
.highlight .kp {
  color: #f92672;
}
.highlight .o {
  color: #f92672;
}
    </style>
    <link href="stylesheets/screen.css" rel="stylesheet" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" media="print" />
      <script src="javascripts/all.js"></script>
  </head>

  <body class="index" data-languages="[&quot;python&quot;]">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" alt="Navbar" />
      </span>
    </a>
    <div class="toc-wrapper">
        <div class="lang-selector">
              <a href="#" data-language-name="python">python</a>
        </div>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <ul id="toc" class="toc-list-h1">
          <li>
            <a href="#welcome" class="toc-h1 toc-link" data-title="Welcome">Welcome</a>
          </li>
          <li>
            <a href="#installation" class="toc-h1 toc-link" data-title="Installation">Installation</a>
          </li>
          <li>
            <a href="#mission" class="toc-h1 toc-link" data-title="Mission">Mission</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#data-pipelines" class="toc-h2 toc-link" data-title="Data Pipelines">Data Pipelines</a>
                  </li>
                  <li>
                    <a href="#parallel-async-distributed" class="toc-h2 toc-link" data-title="Parallel/Async/Distributed">Parallel/Async/Distributed</a>
                  </li>
                  <li>
                    <a href="#for-data-science-and-data-engineering-with-love" class="toc-h2 toc-link" data-title="For data-science and data-engineering with love">For data-science and data-engineering with love</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#get-started" class="toc-h1 toc-link" data-title="Get started">Get started</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#project" class="toc-h2 toc-link" data-title="Project">Project</a>
                  </li>
                  <li>
                    <a href="#app" class="toc-h2 toc-link" data-title="App">App</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#app-components" class="toc-h1 toc-link" data-title="App components">App components</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#pipeline" class="toc-h2 toc-link" data-title="Pipeline">Pipeline</a>
                  </li>
                  <li>
                    <a href="#flow" class="toc-h2 toc-link" data-title="Flow">Flow</a>
                  </li>
                  <li>
                    <a href="#producer" class="toc-h2 toc-link" data-title="Producer">Producer</a>
                  </li>
                  <li>
                    <a href="#consumer" class="toc-h2 toc-link" data-title="Consumer">Consumer</a>
                  </li>
                  <li>
                    <a href="#app-config" class="toc-h2 toc-link" data-title="APP Config">APP Config</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#examples" class="toc-h1 toc-link" data-title="Examples">Examples</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#etl-example-hacker-news" class="toc-h2 toc-link" data-title="ETL example: hacker news">ETL example: hacker news</a>
                  </li>
                  <li>
                    <a href="#ml-example-bag-of-words" class="toc-h2 toc-link" data-title="ML example: bag of words">ML example: bag of words</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#features" class="toc-h1 toc-link" data-title="Features">Features</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#inspect-status-of-your-queues" class="toc-h2 toc-link" data-title="Inspect status of your queues">Inspect status of your queues</a>
                  </li>
                  <li>
                    <a href="#shell" class="toc-h2 toc-link" data-title="Shell">Shell</a>
                  </li>
                  <li>
                    <a href="#change-queue-streaming-server" class="toc-h2 toc-link" data-title="Change queue/streaming server">Change queue/streaming server</a>
                  </li>
                  <li>
                    <a href="#admin-panel" class="toc-h2 toc-link" data-title="Admin panel">Admin panel</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#faq" class="toc-h1 toc-link" data-title="FAQ">FAQ</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#what-the-reason-behind-apps" class="toc-h2 toc-link" data-title="What the reason behind apps?">What the reason behind apps?</a>
                  </li>
                  <li>
                    <a href="#why-pipeline-builder-using-quot-mocked-quot-data" class="toc-h2 toc-link" data-title="Why pipeline builder using "mocked" data ?">Why pipeline builder using "mocked" data ?</a>
                  </li>
                  <li>
                    <a href="#what-data-should-return-each-pipeline-component" class="toc-h2 toc-link" data-title="What data should return each pipeline component ?">What data should return each pipeline component ?</a>
                  </li>
              </ul>
          </li>
      </ul>
        <ul class="toc-footer">
            <li><a href='https://github.com/electronick1/stairs'>Stairs on github</a></li>
            <li><a href='https://github.com/electronick1/stepist'>Stepist on github</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <h1 id='welcome'>Welcome</h1>
<p>Stairs is a simple tool which allows you to slice and dice and make sense of 
your data. </p>

<p>You can build data pipelines and make parallel, async or distributed calculations 
for most of your data related tasks.</p>

<p>Stairs available for Python3, but you can write data processors in any language. 
You can also use any of streaming or queue services which you want. </p>

<p>It&#39;s easy to start, test all your ideas or hypotheses in a quick way and it is 
ready for immediate use without any special magic. </p>

<p>Get started with Installation and then get an overview with &quot;Get started&quot;. </p>
<h1 id='installation'>Installation</h1><pre class="highlight python tab-python"><code><span class="c"># install redis https://redis.io/topics/quickstart</span>
<span class="c"># sudo apt-get install redis</span>
<span class="c"># brew install redis</span>

<span class="n">pip</span> <span class="n">install</span> <span class="n">stairs</span><span class="o">-</span><span class="n">project</span>
</code></pre>
<blockquote>
<p>It&#39;s recommended to use the latest python 3 version</p>
</blockquote>

<p>Just make <code>pip install stairs-project</code> to install stairs along with all 
python dependencies.</p>

<p>Stairs requires redis for storing statistic and some meta-information, 
even if you use different streaming or queue service. </p>

<aside class="notice">
Stairs requires a running redis server to work
</aside>
<h1 id='mission'>Mission</h1><h2 id='data-pipelines'>Data Pipelines</h2>
<!-- > ![image](images/data_pipeline.png) -->

<p>The main Stairs focus is data pipelines. It&#39;s a framework which helps you to
build and manipulate data through the data flow graph. </p>

<p>You can think of it as of an MVP framework (like Django) for data pipelines.
Different layers of abstractions and components allow you to build any kind of 
data flow graph and easily understand what&#39;s going on in your system. </p>
<h2 id='parallel-async-distributed'>Parallel/Async/Distributed</h2>
<!-- > ![parallel](images/parallel.png) -->

<p>Each component of data pipeline could be represented as a separate python 
process (worker). Each component comunicates with each other using 
streaming/queues services and together could process your data in a parallel way.</p>

<p>Right now stairs using: <br>
- celery <br>
- self-implemented redis queue <br>
- kafka (under development) <br></p>

<p>There is interesting wiki article about workers/jobs 
-&gt; <a href="https://en.wikipedia.org/wiki/Job_(computing)">Wiki</a></p>

<p>Stairs framework focusing on speed and light, and speed 
of your &quot;workers&quot; mostly limited by your streaming/queues service.</p>
<h2 id='for-data-science-and-data-engineering-with-love'>For data-science and data-engineering with love</h2>
<!-- > ![ds_en](images/ds_en.svg) -->

<p>Data-science and data-engineering growing fast, and it&#39;s hard 
to be expert on everything at the same time. </p>

<p>For example to train ML models, you should spend about 80% of the time 
to process data -- how fast you will be able to process your data and test 
all hypotheses, directly influence your final result.</p>

<p>Stairs allows data scientist to build &quot;scalable&quot; solutions without 
high-level data-engineering skills.</p>

<ul>
<li>Data-scientist could focus only on data processing</li>
<li>Data-engineer could focus only on storing and moving data 
(between pipeline components)</li>
</ul>
<h1 id='get-started'>Get started</h1><h2 id='project'>Project</h2><pre class="highlight shell tab-shell"><code>stairs-admin project:new name
</code></pre>
<blockquote>
<p><img src="images/project.svg" alt="project" /></p>
</blockquote>

<p>When you done with installation let&#39;s try to kick-start your first stairs project.</p>

<p>Stairs project kind similar to django approach (when you can create default 
project template). To have better overview of your components you can create 
similar project in stairs. It will contain apps with all basic layears inside. <bt>
But you completely free to use another structure which you want. Default 
project template is just a way to quikly kick start your idea. </p>

<p>For creating default project template just use the following command:</p>

<p><code>stairs-admin project:new name</code></p>

<p>This command will generate a basic project structure with one app inside.<br></p>

<p>The project has a config file and &quot;manager.py&quot;.</p>

<p>&quot;manager.py&quot; - in Django manner allows you to read config, detect apps and 
execute shell commands.</p>

<p><br><br><br><br><br><br></p>
<h2 id='app'>App</h2><pre class="highlight shell tab-shell"><code>stairs-admin app:new name
</code></pre>
<blockquote>
<p><img src="images/app.svg" alt="app" /></p>
</blockquote>

<p>App - it&#39;s a way to generalize different approaches to one similar form - why? 
Because right now data-science approaches too scattered and it&#39;s hard to 
understand what&#39;s going on when you have a ton of maths and algorithms around. </p>

<p>Each app has the following components:</p>

<ul>
<li><p>pipeline - represents a data flow graph and determines how the data 
will be processed. Each pipeline consists of multiple smaller components 
like &quot;Flow&quot; (Data flow).  </p></li>
<li><p>producer - function which helps you to read the source 
(file, database ...) and then follow it to data pipeline.</p></li>
<li><p>consumer - function which writes data to data store 
or change &quot;global state&quot;.</p></li>
<li><p>flow (Data Flow) - set of functions 
(called <a href="https://en.wikipedia.org/wiki/Job_(computing)">steps</a>
which could change/filter/populate your data.</p></li>
</ul>

<p>To create new &quot;default app&quot; structure (with package and modules) 
type following command:</p>

<p><code>stairs-admin app:new name</code></p>
<pre class="highlight python tab-python"><code><span class="kn">from</span> <span class="nn">stairs</span> <span class="kn">import</span> <span class="n">App</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">App</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"my_app"</span><span class="p">)</span>

</code></pre>
<p>To define your app you should initialize App object with name and config 
(More about app config in &quot;App components&quot; section).
You can find this app object in &quot;app_config.py&quot; file inside default app. 
Don&#39;t forget to change it name. </p>

<p>If you want to add a new app to the project, populate 
<code>apps</code> variable in the config file or use <code>StairsProject().add_app(app)</code></p>

<p><br></p>

<p><img src="images/app_2.svg" alt="image" /></p>

<p><br></p>
<h1 id='app-components'>App components</h1><h2 id='pipeline'>Pipeline</h2><pre class="highlight python tab-python"><code>
<span class="nd">@app.pipeline</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">my_pipeline</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">subscribe_func</span><span class="p">(</span><span class="n">my_function_which_process_data</span><span class="p">,</span> <span class="n">as_worker</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> \
                <span class="o">.</span><span class="n">subscribe_flow</span><span class="p">(</span><span class="n">MySecondFlow</span><span class="p">())</span>\
                <span class="o">.</span><span class="n">subscribe_consumer</span><span class="p">(</span><span class="n">save_result</span><span class="p">)</span>

</code></pre>
<p>Pipeline - it&#39;s a way to connect multiple objects (functions/classes/other pipelines) into one big graph. </p>

<p>The way how it&#39;s works a bit tricky but quite simple to understand. Input of each pipeline could be any data you want, then
you can subscribe some objects to this data, and connect more and more objects to one big graph which super easy to understand
and manipulate.</p>

<p>Each pipeline component - could be a worker, which communicates with other components through streaming/queue service.</p>

<p>To run pipeline (and let data go through pipeline components) use: <br>
<code>python manager.py pipelines:run</code></p>

<p>It will run all workers and start process your queue (using streaming/queue service).</p>

<p>If you want to run some particular pipeline use following command: <br>
<code>python manager.py pipelines:run app_name.pipeline_name</code> <br></p>

<p>Let&#39;s dive a bit deeply to pipelines structure:</p>

<p><br></p>

<p><img src="images/pipeline_1.svg" alt="image" /></p>

<p><br><br></p>

<hr>
<pre class="highlight python tab-python"><code>
<span class="nd">@app.pipeline</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">full_pipeline</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">value1</span><span class="p">,</span> <span class="n">value2</span><span class="p">,</span> <span class="n">value3</span><span class="p">):</span>

    <span class="c"># DataFrame</span>
    <span class="n">all_at_once</span> <span class="o">=</span> <span class="n">concatinate</span><span class="p">(</span><span class="n">data_point1</span><span class="o">=</span><span class="n">value1</span><span class="p">,</span>
                              <span class="n">data_point2</span><span class="o">=</span><span class="n">value2</span><span class="p">,</span>
                              <span class="n">data_point3</span><span class="o">=</span><span class="n">value3</span><span class="p">)</span>

    <span class="c"># DataFrame</span>
    <span class="n">my_flow_result</span> <span class="o">=</span> <span class="n">all_at_once</span><span class="o">.</span><span class="n">subscribe_func</span><span class="p">(</span><span class="n">my_function</span><span class="p">,</span> <span class="n">as_worker</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c"># DataPoint</span>
    <span class="n">flow_data_point</span> <span class="o">=</span> <span class="n">my_flow_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">"result_data_point"</span><span class="p">)</span>

    <span class="c"># DataFrame</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">flow_data_point</span><span class="o">.</span><span class="n">subscribe_flow</span><span class="p">(</span><span class="n">MyFlow2</span><span class="p">())</span>\
                            <span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="n">flow2_result</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>

<span class="nd">@app.pipeline</span>
<span class="k">def</span> <span class="nf">short_pipeline</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">value1</span><span class="p">,</span> <span class="n">value2</span><span class="p">,</span> <span class="n">value3</span><span class="p">):</span>

    <span class="c"># DataFrame</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">concatinate</span><span class="p">(</span><span class="n">data_point1</span><span class="o">=</span><span class="n">value1</span><span class="p">,</span> 
                         <span class="n">data_point2</span><span class="o">=</span><span class="n">value2</span><span class="p">,</span> 
                         <span class="n">data_point3</span><span class="o">=</span><span class="n">value3</span><span class="p">)</span>\
             <span class="o">.</span><span class="n">subscribe_func</span><span class="p">(</span><span class="n">my_function</span><span class="p">,</span> <span class="n">as_worker</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>\
             <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">"result1"</span><span class="p">)</span>\
             <span class="o">.</span><span class="n">subscribe_flow</span><span class="p">(</span><span class="n">MyFlow2</span><span class="p">())</span>\
             <span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="s">'result1'</span><span class="p">)</span>\

    <span class="k">return</span> <span class="n">result</span>

</code></pre><h3 id='manipulating-data-inside-pipeline'>Manipulating data inside pipeline</h3>
<p>An input of stairs pipeline is a <a href="https://en.wikipedia.org/wiki/Mock_object">&quot;mock&quot;</a> values called &quot;DataPoint&quot; - it&#39;s a representation of the ANY data which will be executed inside pipeline components. </p>

<p>The mock data will be converted to &quot;real&quot; data as soon as you call pipeline: <br></p>

<p><code>short_pipeline(value1=1, value2=2, value3=3)</code> <br></p>

<p>But this &quot;real&quot; data will be accesseble only inside functions and flows which you used in subscribe methods.
(you can&#39;t use &quot;real&quot; values directly inside pipeline function - this function it&#39;s just for building pipelines, not for data manipulation)</p>

<p>You can subscribe DataPoint by some function or Flow component and result of this subscription will be a new object called &quot;DataFrame&quot; 
(kind of dict object with key:DataPoint structure) - it represents a result of your flow.</p>

<p>You could subscribe both DataPoint or DataFrame. But if you want to extract some values from DataFrame (the result of your flow) you can use
<code>get(&#39;value&#39;)</code> method. The result of the &quot;get&quot; method will be DataPoint.</p>

<p>If you want to modify your DataFrame you can use <code>make(value=new_value)</code> method and result will be new DataFrame.</p>

<p>Now one of the most interesting part: If you want to combine multiple DataPoints and DataFrame into one DataFrame you can use 
<code>concatenate(value1=data_point, value2=data_point2)</code> function - which return DataFrame with defined arguments. </p>

<p>Here an example of the pipeline -&gt; </p>

<p>As you can see It&#39;s quite simple to define such complex and hard architecture just with 6 lines of code.
And it&#39;s a bit similar to how we define Neural Networks using <a href="https://keras.io/">Keras</a></p>

<p><br></p>

<p><img src="images/pipeline_2.svg" alt="image" />
<br><br></p>

<hr>
<pre class="highlight python tab-python"><code>
<span class="nd">@app.pipeline</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">my_pipeline</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">subscribe_flow</span><span class="p">(</span><span class="n">MyFlow</span><span class="p">(),</span> <span class="n">as_worker</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> \
                <span class="o">.</span><span class="n">apply_flow</span><span class="p">(</span><span class="n">MySecondFlow</span><span class="p">())</span>\
                <span class="o">.</span><span class="n">subscribe_consumer</span><span class="p">(</span><span class="n">save_result</span><span class="p">)</span>

</code></pre><h3 id='how-pipeline-flow-change-data'>How pipeline flow change data</h3>
<p>Pipeline components could accumulate data or completely change/redefine it. </p>

<p>For this stairs has two definitions: <br>
- subscribe_smths <br>
- apply_smths <br></p>

<p>subscribe - accumulate/update data <br>
apply - completely redefine data based on pipeline component result. </p>

<p>Take into consideration that result of each component is a dict object, which
&quot;accumulate&quot; by updating dict keys and values</p>

<p><br><br></p>

<p><img src="images/pipeline_3.svg" alt="image" /></p>

<p><br></p>

<hr>
<pre class="highlight python tab-python"><code>
<span class="nd">@app.pipeline</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">base_pipeline</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">subscribe_flow</span><span class="p">(</span><span class="n">BaseFlow</span><span class="p">(</span><span class="o">**</span><span class="n">pipeline</span><span class="o">.</span><span class="n">config</span><span class="p">))</span>

<span class="nd">@app.pipeline</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">my_pipeline</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">subscribe_pipeline</span><span class="p">(</span><span class="n">base_pipeline</span><span class="p">)</span>\
                <span class="o">.</span><span class="n">subscribe_consumer</span><span class="p">(</span><span class="n">save_result</span><span class="p">)</span>

<span class="nd">@app.pipeline</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">my_pipeline_with_config</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="n">config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">use_lower</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">subscribe_pipeline</span><span class="p">(</span><span class="n">base_pipeline</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>\
                <span class="o">.</span><span class="n">subscribe_consumer</span><span class="p">(</span><span class="n">save_result</span><span class="p">)</span>

</code></pre><h3 id='call-another-pipeline'>Call another pipeline</h3>
<p>Each stairs pipeline is a worker which handle jobs in a separate process.<br>
Inside your pipeline, you can use any other pipelines and send data between
them using queue/streaming service. </p>

<p>Note: you can&#39;t set worker=False to a pipeline. </p>

<p>One of the core feature inside pipelines is a scalable way to configure them. 
The app and pipelines structure is quite friendly for configuration, 
you can set new config values when call new pipeline</p>

<p><code>value.subscribe_pipeline(base_pipeline, config=dict(path=&#39;/home&#39;))</code></p>

<p>This values will be available inside <code>base_pipeline</code> as:</p>

<p><code>pipeline.config.get(&#39;path&#39;)</code></p>

<p><br><br><br><br><br><br><br><br><br><br><br></p>

<hr>
<pre class="highlight python tab-python"><code>
<span class="k">def</span> <span class="nf">custom_function</span><span class="p">(</span><span class="n">new_value</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">new_value</span><span class="o">=</span><span class="n">new_value</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>


<span class="nd">@app.pipeline</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">base_pipeline</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">value</span>\
        <span class="o">.</span><span class="n">subscribe_func</span><span class="p">(</span><span class="k">lambda</span> <span class="n">value</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">new_value</span><span class="o">=</span><span class="n">value</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s">'plus_one'</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">subscribe_func</span><span class="p">(</span><span class="n">custom_function</span><span class="p">,</span> <span class="n">as_worker</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</code></pre><h3 id='subscribe-any-function-you-want'>Subscribe any function you want</h3>
<p>It&#39;s possible to add any function you want inside your data pipeline. </p>

<p>If you are using lambda function it&#39;s quite important to set name, because otherwise
if this function will be a worker it will be impossible to recognize it. </p>

<p>Note: that all functions should return <code>dict</code> object.</p>

<p><br><br><br><br><br><br><br><br><br><br><br></p>

<hr>
<pre class="highlight python tab-python"><code>
<span class="k">def</span> <span class="nf">custom_function</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">new_value</span><span class="o">=</span><span class="n">new_value</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>


<span class="nd">@app.pipeline</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">base_pipeline</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">value</span>\
        <span class="o">.</span><span class="n">subscribe_func</span><span class="p">(</span><span class="n">custom_function</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="s">'/tmp/save_data.txt'</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">subscribe_consumer</span><span class="p">(</span><span class="n">save_to_file</span><span class="p">,</span> <span class="n">as_worker</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</code></pre><h3 id='custom-values'>Custom values</h3>
<p>It&#39;s possible to add some additional values (with real data) into your pipeline. </p>

<p>It useful when you want to configure something with constant variables or using
pipeline config:</p>

<p><code>data.add_value(pipeline.config.get(&#39;url&#39;))</code></p>

<p><br><br><br><br><br><br><br><br><br><br><br></p>
<h2 id='flow'>Flow</h2><pre class="highlight python tab-python"><code><span class="k">class</span> <span class="nc">MyFlow</span><span class="p">(</span><span class="n">Flow</span><span class="p">)</span>
    <span class="nd">@step</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">first_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">first_step_result</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@step</span><span class="p">(</span><span class="n">first_step</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">second_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first_step_result</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">second_step_result</span><span class="o">=</span><span class="n">first_step_result</span><span class="p">)</span>
</code></pre>
<p>Flow - It&#39;s a low-level component which actually defines data pipeline. </p>

<p>The problem with data pipelines builders that&#39;s it&#39;s not quite easy to 
change/redefine something, also big amount of functions
makes pipelines like a hell of dependences (luigi good example of it). <br>
For solving this problems we have FLOW component which can be used for: <br></p>

<ul>
<li>Easy change/redefine/extend your pipeline. (Just use python inheretence)</li>
<li>Easy to configure </li>
<li>Easy to understand what&#39;s going on</li>
<li>Each Flow could be a worker - Flow have steps which should be run inside some worker</li>
</ul>

<p>Flow represents data flow graph as a chain of functions called &quot;steps&quot;. You can connect those steps simply define &quot;next step&quot; in decorator:</p>

<p><code>@step(next_step, next_step ... )</code></p>

<p>The last step in your graph should be defined with next step set to None.</p>

<p><code>@step(None)</code></p>

<p>All steps executed in one &quot;worker&quot; (process).</p>

<p>The structure of <code>Flow</code> class actually insperead by <a href="https://github.com/electoronick1/stepist">stepist</a></p>

<hr>
<pre class="highlight python tab-python"><code><span class="k">class</span> <span class="nc">MyFlow</span><span class="p">(</span><span class="n">Flow</span><span class="p">):</span>
    <span class="nd">@step</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">third_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">first_step_result</span><span class="p">,</span> <span class="n">second_step_result</span><span class="p">):</span>
        <span class="c"># which actually means value * 3</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">flow_result</span><span class="o">=</span><span class="n">value</span><span class="o">+</span><span class="n">first_step_result</span><span class="o">+</span><span class="n">second_step_result</span><span class="p">)</span>

    <span class="nd">@step</span><span class="p">(</span><span class="n">third_step</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">second_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first_step_result</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">second_step_result</span><span class="o">=</span><span class="n">first_step_result</span><span class="p">)</span>

    <span class="nd">@step</span><span class="p">(</span><span class="n">second_step</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">first_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">first_step_result</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>    

</code></pre>
<p>The input for the next step is output from the current. </p>

<p>This idea is based on <a href="https://github.com/electronick1/stepist">stepist</a></p>

<p>Result of each step is accumulating, this means that from any low-level steps 
you will be able to get values from high-level steps.</p>

<p><br><br><br><br><br><br><br><br><br><br></p>

<hr>
<pre class="highlight python tab-python"><code><span class="k">class</span> <span class="nc">MyFlow</span><span class="p">(</span><span class="n">Flow</span><span class="p">):</span>
    <span class="nd">@step</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">second_step_2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@step</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">second_step_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@step</span><span class="p">(</span><span class="n">second_step_1</span><span class="p">,</span> <span class="n">second_step_2</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">first_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># this step will be executed right after</span>
        <span class="c"># root1 and root2</span>
        <span class="c"># data from root1 and root2 will be merge into current step</span>
        <span class="k">pass</span>
</code></pre>
<p>You can define multiple &quot;next&quot; steps and this will allow you to build complex 
branched out pipelines, like on example bellow -&gt;</p>

<p><img src="images/flow1.svg" alt="image" />
<br><br><br><br><br></p>

<hr>
<pre class="highlight python tab-python"><code><span class="kn">from</span> <span class="nn">stairs</span> <span class="kn">import</span> <span class="n">FLow</span><span class="p">,</span> <span class="n">step</span>

<span class="k">class</span> <span class="nc">MyFlow</span><span class="p">(</span><span class="n">Flow</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result_for_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_stats</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">result_for_4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_stats</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result_for_2</span><span class="o">.</span><span class="n">validate_data</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">result_for_4</span><span class="o">.</span><span class="n">validate_data</span><span class="o">.</span><span class="n">value</span>

    <span class="nd">@step</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">validate_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@step</span><span class="p">(</span><span class="n">validate_data</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">calculate_stats</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span> <span class="o">**</span> <span class="mi">2</span>

</code></pre>
<p>Now, to execute your flow class you should have <code>__call__</code> method defenied. </p>

<p>Inside <code>__call__</code> you can execute any step from your flow. Then whole chain 
(pipeline) of steps will be executed. </p>

<p><code>self.mystep(**kwargs_for_highest_step)</code></p>

<p>or</p>

<p><code>self.start_from(self.mystep, **kwargs_for_highest_step)</code></p>

<p>As a result, you will get data from the last step in your pipeline (with the next_step set to None).</p>

<p><br><br><br><br><br><br><br><br><br><br><br></p>

<hr>
<pre class="highlight python tab-python"><code><span class="kn">from</span> <span class="nn">stairs</span> <span class="kn">import</span> <span class="n">FLow</span><span class="p">,</span> <span class="n">step</span>

<span class="k">class</span> <span class="nc">MyFlow</span><span class="p">(</span><span class="n">Flow</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_from</span><span class="p">(</span><span class="n">first_step</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">result</span><span class="o">.</span><span class="n">first_step</span><span class="p">,</span> <span class="o">**</span><span class="n">result</span><span class="o">.</span><span class="n">second_step</span><span class="p">}</span>

    <span class="nd">@step</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">second_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">power3</span><span class="o">=</span><span class="n">value</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>

    <span class="nd">@step</span><span class="p">(</span><span class="n">second_step</span><span class="p">,</span> <span class="n">save_result</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">first_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">power2</span><span class="o">=</span><span class="n">value</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</code></pre>
<p>It&#39;s also possible to customize steps which should return back result data. 
Just set <code>save_result</code> flag to True. </p>

<p><br><br><br></p>

<p><img src="images/flow2.svg" alt="image" /></p>

<p><br><br></p>

<hr>
<pre class="highlight python tab-python"><code><span class="kn">from</span> <span class="nn">stairs</span> <span class="kn">import</span> <span class="n">FLow</span><span class="p">,</span> <span class="n">step</span>

<span class="k">class</span> <span class="nc">MyFlow</span><span class="p">(</span><span class="n">Flow</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_from</span><span class="p">(</span><span class="n">first_step</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">result</span><span class="o">.</span><span class="n">first_step</span><span class="p">,</span> <span class="o">**</span><span class="n">result</span><span class="o">.</span><span class="n">second_step</span><span class="p">}</span>

    <span class="nd">@step</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">second_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">power3</span><span class="o">=</span><span class="n">value</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>

    <span class="nd">@step</span><span class="p">(</span><span class="n">second_step</span><span class="p">,</span> <span class="n">save_result</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">first_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">power2</span><span class="o">=</span><span class="n">value</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MyFlow2</span><span class="p">(</span><span class="n">MyFlow</span><span class="p">):</span>

    <span class="nd">@step</span><span class="p">(</span><span class="n">second_step</span><span class="p">,</span> <span class="n">save_result</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">first_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">power4</span><span class="o">=</span><span class="n">value</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span>
</code></pre>
<p>Flow - it&#39;s a class, this means we could use inheritance to redefine some steps logic.</p>

<p>It&#39;s a very powerfull way to extend/change your data pipeline. </p>

<p><br><br></p>

<p><img src="images/flow3.svg" alt="image" /></p>

<p><br><br><br><br><br><br></p>

<hr>
<pre class="highlight python tab-python"><code><span class="kn">from</span> <span class="nn">stairs</span> <span class="kn">import</span> <span class="n">FLow</span><span class="p">,</span> <span class="n">step</span>

<span class="k">class</span> <span class="nc">MyFlow</span><span class="p">(</span><span class="n">Flow</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_from</span><span class="p">(</span><span class="n">first_step</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">result</span><span class="o">.</span><span class="n">first_step</span><span class="p">,</span> <span class="o">**</span><span class="n">result</span><span class="o">.</span><span class="n">second_step</span><span class="p">}</span>

    <span class="nd">@step</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">second_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">power3</span><span class="o">=</span><span class="n">value</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>

    <span class="nd">@step</span><span class="p">(</span><span class="n">second_step</span><span class="p">,</span> <span class="n">save_result</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">first_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">power2</span><span class="o">=</span><span class="n">value</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MyFlow2</span><span class="p">(</span><span class="n">MyFlow</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__reconect__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">second_step</span><span class="o">.</span><span class="n">set_next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">third_step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">second_step</span><span class="o">.</span><span class="n">save_result</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="nd">@step</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">third_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">power4</span><span class="o">=</span><span class="n">value</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span>
</code></pre>
<p>Inheritance also allows you to reconnect some steps and change Flow structure.</p>

<p>It&#39;s possible to add a new step to the top, insert in the middle or add &quot;save_result&quot; flag.</p>

<p><br><br></p>

<p><img src="images/flow4.svg" alt="image" /></p>

<p><br><br></p>
<h2 id='producer'>Producer</h2>
<p>Producer - it&#39;s a set of components for reading any types of data and then call pipeline to handle your data.</p>

<p>This component will populate your pipeline by &quot;real&quot; data which you can read from any source you want. </p>

<p>So far, We have two types of producer components: <br></p>

<ul>
<li>simple iterator <br></li>
<li>worker iterator - the way to safely read your data <br></li>
</ul>

<p>When you define producer you can call it from shell using manager.py:
<code>python manager.py producer:process</code></p>

<p><br><br></p>

<hr>
<pre class="highlight python tab-python"><code>
<span class="nd">@app.producer</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">my_pipeline</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">read_file</span><span class="p">():</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">FILE_PATH</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">row</span>

</code></pre><h3 id='simple-producer'>Simple Producer</h3>
<p>It&#39;s an iterator function which yields data to pipeline. You can run this &quot;producer&quot; from console:<br>
<code>python manager.py producer:process</code></p>

<p>It&#39;s simply going by all items which producers yields and send them to streaming/queue service which then goes to pipeline. </p>

<p>To prevent overfitting of your streaming service you can set &quot;limit&quot; and at the moment when producer reaches this limit it will sleep for a while. </p>

<p><br><br><br></p>

<hr>
<pre class="highlight python tab-python"><code>
<span class="nd">@app.worker_producer</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">my_pipeline</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">read_database</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">AMOUNT_OF_ROWS</span> <span class="o">/</span> <span class="n">BATCH_SIZE</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">read_batch</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">read_batch</span><span class="p">(</span><span class="n">batch_id</span><span class="p">):</span>
    <span class="n">interval</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch_id</span><span class="o">*</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="p">(</span><span class="n">batch_id</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">BATCH_SIZE</span><span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"SELECT * FROM table where id&gt;</span><span class="si">%</span><span class="s">s and id&lt;</span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="n">interval</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">row</span>

</code></pre><h3 id='worker-producer'>Worker Producer</h3>
<p>It&#39;s a parallel/distributed way to populate your pipeline with data. It&#39;s almost 99% safe - it has smart features to prevent data loss or duplication.</p>

<p>The way how it works a bit complex then simple producer, but if you know something about &quot;batch&quot; processing - everything will be simple for you.</p>

<p>The idea to split your data by batches and read each batch independently. If the whole batch was read successfully it goes to pipeline. Internally Worker producer
using bitmaps to track all your batches status, and the only way when you can lose your data is a fail with redis.</p>

<p>Worker producer has two states: first initializing - it&#39;s just checking the number of batches and creates all needed meta information. 
To initilaze worker_producer run: <br>
<code>python manager.py producer:init</code></p>

<p>It should be executed only once.</p>

<p><br></p>

<p>Then to start reading process you can run: <br>
<code>python manager.py producer:process</code></p>

<p>As it was mentioned before worker_producer - it&#39;s a parallel way to read your data. So if you want more processes just run the command above multiple times. 
It will read batches from <code>producer:init</code> command.</p>

<p>In the same way like simple_producer it will prevent the queue from overfitting. </p>

<p><br><br><br></p>
<h2 id='consumer'>Consumer</h2><pre class="highlight python tab-python"><code><span class="nd">@app.consumer</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">save_to_redis</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">):</span>
    <span class="n">redis</span><span class="o">.</span><span class="nb">set</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</code></pre>
<p>Consumer - it&#39;s a set of components for writing/saving your data to any type of store or change the global state of your system.</p>

<p>You are free to write/save your data inside Flow component, but consumer it&#39;s not only about saving - it&#39;s a way to accumulate all
data to one place, and stairs has 3 types of consumers:</p>

<ul>
<li>&quot;simple consumer&quot; - just a simple function which should not return any data. Useful for saving data to data store.</li>
<li>&quot;standalone_consumer&quot; - function which could be called as a separate process. Useful for writing data to a file or accumulating it inside one process for something. </li>
<li>&quot;consumer_iter&quot; - function which yields data from the pipeline. Useful when you want to train the neural network and needs data generator. </li>
</ul>

<p>Here on the right example of &quot;simple consumer&quot; -&gt; 
<br><br></p>

<hr>
<pre class="highlight python tab-python"><code><span class="kn">import</span> <span class="nn">json</span>

<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"file.txt"</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span>

<span class="nd">@app.standalone_consumer</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">write_to_file</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">):</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

</code></pre>
<p>Standalone consumer it&#39;s a type of consumer which will NOT execute automatically.</p>

<p>To execute it and process data inside, you need to run a special command:</p>

<p><code>python manager.py consumer:standalone app.write_to_file</code></p>

<p>It useful when you need to write data using one process only (for example in case of file writing).</p>

<hr>
<pre class="highlight python tab-python"><code>
<span class="nd">@app.consumer_iter</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">x_data_for_nn</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">data</span>

<span class="nd">@app.consumer_iter</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">y_data_for_nn</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">data</span>


<span class="c"># Example of pipeline</span>
<span class="nd">@app.pipeline</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">prepare_data_for_nn</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">result_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">subscribe_flow</span><span class="p">(</span><span class="n">Flow</span><span class="p">())</span>

    <span class="n">x_consumer</span> <span class="o">=</span> <span class="n">result_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'x'</span><span class="p">)</span>\
                            <span class="o">.</span><span class="n">subscribe_consumer</span><span class="p">(</span><span class="n">x_data_for_nn</span><span class="p">)</span>
    <span class="n">y_consumer</span> <span class="o">=</span> <span class="n">result_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'y'</span><span class="p">)</span>\
                            <span class="o">.</span><span class="n">subscribe_consumer</span><span class="p">(</span><span class="n">y_data_for_nn</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">concatinate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x_consumer</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_consumer</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span>

<span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x_data_for_nn</span><span class="p">(),</span>
                  <span class="n">y</span><span class="o">=</span><span class="n">y_data_for_nn</span><span class="p">())</span>


</code></pre>
<p>Consumer as a separe process.</p>

<p>If you want to train a neural network, and use an output of your pipeline as a train set, you can use:<br>
<code>@consumer_iter()</code> component which allows you to read data from streaming/queue service directly to your function.</p>
<h2 id='app-config'>APP Config</h2><pre class="highlight python tab-python"><code>
<span class="c"># app_config.py</span>

<span class="kn">from</span> <span class="nn">stairs</span> <span class="kn">import</span> <span class="n">App</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">App</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"myapp"</span><span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s">"use_validation"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>

<span class="n">my_pipeline_config</span> <span class="o">=</span> <span class="p">{</span><span class="s">"validation_flow"</span><span class="p">:</span> <span class="n">ValidationFLow</span><span class="p">()}</span>

<span class="c"># pipelines.py</span>

<span class="nd">@app.pipeline</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">my_pipeline_config</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_pipeline</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">subscribe_flow</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">validation_flow</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">use_validation</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">subscribe_flow</span><span class="p">(</span><span class="n">ValidationFLow</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">result</span>


<span class="c"># another project</span>

<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">use_validation</span> <span class="o">=</span> <span class="bp">True</span>

</code></pre>
<p>It&#39;s a place when you can set up your app. </p>

<p>App config allows defining app settings which useful when you want to share your app with the world.</p>

<p>Here it&#39;s also possible to define pipeline config like on example -&gt; </p>

<p><br></p>
<h1 id='examples'>Examples</h1><h2 id='etl-example-hacker-news'>ETL example: hacker news</h2>
<p><a href="https://github.com/electronick1/stairs_examples/tree/master/hacker_news">github hacker_news</a><br></p>

<p>The idea here is to extract data from some source (in that case google cloud), change it somehow and save in a elegant format 
(for example for creating charts then, or building neural networks).</p>

<p>You can start exploring this project from <code>producers.py</code> inside hacker_new app. 
In this module it&#39;s quite trivial where we are reading data, and what format we are using as a result</p>

<p>Then <code>pipelines.py</code> each producer will send data to pipelines, in our case we have two of them:<br>
- <code>cleanup_and_save_localy</code> - which makes basic text cleanup and filtering
- <code>calculate_stats</code> - which based on &quot;clean&quot; data calculates some stats which we need</p>

<p>Next (and last) <code>consumers.py</code> - the place where all data comes in the end of pipeline.</p>

<p><br></p>
<h2 id='ml-example-bag-of-words'>ML example: bag of words</h2>
<p><a href="https://github.com/electronick1/stairs_examples/tree/master/bag_of_words">github bag of words</a><br></p>

<p>He we trying to teach some neural network to solve <a href="https://www.kaggle.com/c/word2vec-nlp-tutorial">kaggle task &quot;Bag of Words Meets Bags of Popcorn&quot;</a></p>

<p>This example based on <a href="https://github.com/wendykan/DeepLearningMovies/">this repo</a> And it&#39;s kind of copy-paste solution but to the much more better representation.</p>

<p>What does it means &quot;better representation&quot;? </p>

<p>If you look inside this repo, it&#39;s just a plain code, 
when you want to make calculations in parrallel way it&#39;s not very trivial todo, 
also if you wnt to change something it&#39;s not easy to undestand whole data flow chages.</p>

<p>Stairs solving all of this problems:</p>

<ul>
<li>It make calculations in parallel by default</li>
<li>You can easelly understand what&#39;s going on inside <code>pipelines.py</code></li>
<li>It super easy to change something (just redefine some methods in FLow clases)</li>
</ul>
<h1 id='features'>Features</h1><h2 id='inspect-status-of-your-queues'>Inspect status of your queues</h2><pre class="highlight shell"><code>python manager.py inspect:status app_name

<span class="c"># Queue: cleanup_and_save_localy</span>
<span class="c"># Amount of jobs: 10000</span>
<span class="c"># Queue decreasing by 101.0 tasks per/sec</span>


python manager.py inspect:monitor app_name

<span class="c"># Queue: cleanup_and_save_localy</span>
<span class="c"># Amount of jobs: 3812</span>
<span class="c"># New jobs per/sec: 380.4</span>
<span class="c"># Jobs processed per/sec: 10.0</span>


</code></pre>
<p>There is two types of inspections:</p>

<ul>
<li>inspect:status - return current amount of jobs/tasks in your queue, and basic information about speed (not very accurate)</li>
<li>inspect:monitor - return amount jobs added and processed per sec. Accurate, but working only for redis (so far)</li>
</ul>
<h2 id='shell'>Shell</h2><pre class="highlight shell"><code>python manager.py shell
</code></pre><pre class="highlight python tab-python"><code>
<span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">stairs</span> <span class="kn">import</span> <span class="n">get_project</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">get_project</span><span class="p">()</span><span class="o">.</span><span class="n">get_app</span><span class="p">(</span><span class="s">"hacker_news"</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="o">&lt;</span><span class="n">stairs</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">App</span> <span class="n">at</span> <span class="mh">0x105fa7d30</span><span class="o">&gt;</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">get_project</span><span class="p">()</span><span class="o">.</span><span class="n">get_app</span><span class="p">(</span><span class="s">"hacker_news"</span><span class="p">)</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">producers</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
<span class="p">{</span><span class="s">'read_google_big_table'</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">stairs</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">producer</span><span class="o">.</span><span class="n">Producer</span> <span class="n">at</span> <span class="mh">0x1257c4828</span><span class="o">&gt;</span><span class="p">}</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">producer</span> <span class="o">=</span> <span class="n">get_project</span><span class="p">()</span><span class="o">.</span><span class="n">get_app</span><span class="p">(</span><span class="s">"hacker_news"</span><span class="p">)</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">producers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">"read_google_big_table"</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="n">producer</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>

</code></pre>
<p>It&#39;s possible to run all producers, pipelines, consumers using ipython.</p>
<h2 id='change-queue-streaming-server'>Change queue/streaming server</h2><pre class="highlight python tab-python"><code><span class="c"># in manager.py </span>

<span class="kn">from</span> <span class="nn">stepist</span> <span class="kn">import</span> <span class="n">App</span>
<span class="kn">from</span> <span class="nn">stairs.services.management</span> <span class="kn">import</span> <span class="n">init_cli</span>
<span class="kn">from</span> <span class="nn">stairs.core.project</span> <span class="kn">import</span> <span class="n">StairsProject</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">stepist_app</span> <span class="o">=</span> <span class="n">App</span><span class="p">()</span>
    <span class="n">celery</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="n">broker</span><span class="o">=</span><span class="s">"redis://localhost:6379/0"</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">worker_engine</span> <span class="o">=</span> <span class="n">CeleryAdapter</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">celery</span><span class="p">)</span>

    <span class="n">stairs_project</span> <span class="o">=</span> <span class="n">StairsProject</span><span class="p">(</span><span class="n">stepist_app</span><span class="o">=</span><span class="n">stepist_app</span><span class="p">)</span>
    <span class="n">stairs_project</span><span class="o">.</span><span class="n">load_config_from_file</span><span class="p">(</span><span class="s">"config.py"</span><span class="p">)</span>
    <span class="n">init_cli</span><span class="p">()</span>
</code></pre>
<p>Stairs is complitely based on stepist. You can just define new stepist app with new &quot;broken&quot; engine, 
and your stairs project is ready to go </p>

<p><a href="https://github.com/electronick1/stepist">Stepist</a></p>
<h2 id='admin-panel'>Admin panel</h2><pre class="highlight shell"><code>python manager.py admin
</code></pre>
<p>It&#39;s a way to visualize all your pipelines, see status of queues and all information about each pipeline component</p>

<p><img src="images/admin.png" alt="image" /></p>

<aside class="notice">
Under development
</aside>
<h1 id='faq'>FAQ</h1><h2 id='what-the-reason-behind-apps'>What the reason behind apps?</h2><pre class="highlight python tab-python"><code>
<span class="c"># example of app config</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">App</span><span class="p">(</span><span class="s">"myapp"</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
    <span class="n">train_data_path</span><span class="o">=</span><span class="s">'/home/train.data'</span>
<span class="p">)</span>


<span class="c"># example of pipeline config</span>

<span class="n">pipeline_config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cleanup_flow</span><span class="o">=</span><span class="n">CleanUpText</span><span class="p">())</span>

<span class="nd">@app.pieline</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">external_pipeline</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">subscribe_flow</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cleanup_flow</span><span class="p">)</span>

<span class="c"># in some other app, you can now make like this:</span>
<span class="k">def</span> <span class="nf">my_pipeline</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="n">config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cleanup_flow</span><span class="o">=</span><span class="n">MYCleanup</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">subscribe_pipeline</span><span class="p">(</span><span class="n">external_pipeline</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

<span class="c"># And it ^ will be executed with your "clean up" flow </span>

</code></pre>
<p>The main idea is to simplify reusing externall solutions.</p>

<p>Data-Science world right now is very none standardized and stairs trying to create enviroment
where reusing someone approache will be easy and scalable for you. </p>

<p>For example each app has a config, It&#39;s allow you to set different config variables to external apps (inside your app/project).</p>

<p>Each pipeline has a config. It&#39;s allow you to redefine some pipeline components or change any logic you want. </p>

<p>One of the good example of configs it&#39;s <a href="https://github.com/electronick1/stairs_examples/blob/master/bag_of_words/word2vec/app_config.py">here</a> 
or <a href="https://github.com/electronick1/stairs_examples/blob/master/bag_of_words/word2vec/pipelines.py#L13">here</a></p>
<h2 id='why-pipeline-builder-using-quot-mocked-quot-data'>Why pipeline builder using &quot;mocked&quot; data ?</h2>
<p>Pipeline builder <code>app.pipeline()</code> exists only for creating pipeline, configure it, 
and return &quot;Worker&quot; object which then will be executed using streaming/queue service. </p>

<p>At the moment when we are building pipeline, we don&#39;t know nothing about real data which comes to it latter, 
so thats why we aggeread on some mock values and then populate this &quot;mock&quot; values from producer (or other pipeline).</p>
<h2 id='what-data-should-return-each-pipeline-component'>What data should return each pipeline component ?</h2>
<p>Except &quot;flow_generator&quot; all components should return <code>dict</code> like format. Where we have key:value defined.</p>

<p>It&#39;s used for combaning &quot;real&quot; data with &quot;mock&quot; values. </p>

      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name="python">python</a>
          </div>
        <img src="images/stairs.png" class="stairs" alt="Stairs" />
        <#= image_tag 'data_pipeline.png', class: 'data_pipeline' %>
        <#= image_tag 'parallel.png', class: 'parallel' %>
        <#= image_tag 'ds_en.png', class: 'ds_en' %>
        <#= image_tag 'project_structure.png', class: 'project_structure' %>
        <#= image_tag 'app.png', class: 'app' %>
      </div>
    </div>
  </body>
</html>
